<!doctype html>
<html>

<head>
    <title>annotation tool</title>
    <style>
        .grid_container {
            display: grid;
            grid-template-columns: 49% 49%;
        }
    </style>
</head>

<body>
    <div>
        <span>tiff file</span>
        <input type="file" id="tiff_input" />
    </div>
    <div>
        <span>csv file</span>
        <input type="file" id="csv_input" />
    </div>
    <div class="grid_container">
        <div>
            <p>画像ペイン</p>
            <canvas id="tiff_canvas"></canvas>
            <div>
                <button id="tiff_prev_page">prev</button>
                <input type="range" id="tiff_page_slider"/>
                <button id="tiff_next_page">next</button>
                <span id="tiff_current_page"></span>/<span id="tiff_total_page"></span>
            </div>
            <div>
                <span>表示キーポイント</span>
                <select name="visible_keypoints" id="keypoints_select">
                    <option value="">all</option>
                </select>
            </div>
        </div>
        <div>
            <p>テーブルペイン</p>
            <div style="height: 400px; overflow: auto">
                <table>
                    <thread><tr><th>No</th><th>x座標</th><th>y座標</th><th>ラベル</th><th>削除</th></tr></thread>
                    <tbody id="keypoint_table"></tbody>
                </table>
            </div>
            <button id="keypoint_add">キーポイント追加</button>
            <button id="keypoint_paste">前フレームからペースト</button>
            <p id="keypoint_message_lack"></p>
            <p id="keypoint_message_dupl"></p>
        </div>
    </div>
    <div>
        <button id="keypoint_export">csvエクスポート</button>
    </div>

    <script src="./tiff.min.js"></script>
    <script type="text/javascript">
        Tiff.initialize({TOTAL_MEMORY:  1024*1024*1024});
        var tiff = undefined;
        var pageNum = undefined;
        var keypoints = undefined;
        var selectedKeypointIdx = undefined;

        const tiffInputElement = document.getElementById('tiff_input');
        const csvInputElement = document.getElementById('csv_input');
        const keypointNames = ["Nose", "Left Eye", "Right Eye", "Head", "Tip of Left Ear", "Tip of Right Ear", "Chin", "Left Mouth", "Right Mouth", "Left Cheek", "Right Cheek", "Neck", "Root of Left Shoulder", "Left Shoulder", "Left Elbow", "Left Front Paw", "Tip of Left Front Paw", "Root of Right Shoulder", "Right Shoulder", "Right Elbow", "Right Front Paw", "Tip of Right Front Paw", "Hip", "Root of Left Hip", "Left Hip", "Left Knee", "Left Back Paw", "Tip of Left Back Paw", "Root of Right Hip", "Right Hip", "Right Knee", "Right Back Paw", "Tip of Right Back Paw", "Root of Tail", "Tip of Tail"];
        const keypointColor = 'red';
        const selectedKeypointColor = 'cyan'
        const keypointRadius = 2;
        const scale = 0.125 * 1.58351;

        tiffInputElement.addEventListener('change', () => {
            const tiffFile = tiffInputElement.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                const fileContent = e.target.result;
                tiff = new Tiff({buffer: fileContent});

                // Update total page
                const totalPage = document.getElementById('tiff_total_page');
                totalPage.textContent = tiff.countDirectory();

                // Update slider
                const pageSlider = document.getElementById('tiff_page_slider');
                pageSlider.min = 0;
                pageSlider.max = tiff.countDirectory() - 1;

                // Update keypoints
                keypoints = Array.from({length: tiff.countDirectory()}, () => []);
                updatePageNum(0);
            };
            reader.onerror = (e) => {
                console.error("Error reading file:", e.target.error);
            };
            reader.readAsArrayBuffer(tiffFile);
        });

        csvInputElement.addEventListener('change', () => {
            const csvFile = csvInputElement.files[0];
            const reader = new FileReader();
            reader.onload =(e) => {
                const fileContent = e.target.result;
                // Initialize keypoints
                keypoints = Array.from({length: tiff.countDirectory()}, () => []);
                fileContent.split(/\r?\n/).slice(1).forEach(row => {
                    cols = row.split(',');
                    if (cols.length >= 3) {
                        const t = parseInt(cols[1]);
                        const x = parseInt(cols[3]);
                        const y = parseInt(cols[2]);
                        const k = cols[4] || null;
                        keypoints[t].push({x: x, y: y, k: k});
                    }
                });
                // Render current information
                updatePageNum(pageNum);
            };
            reader.onerror = (e) => {
                console.error('Error reading file:', e.target.error);
            };
            reader.readAsText(csvFile);
        });

        // Initialize button slider
        const pageSlider = document.getElementById('tiff_page_slider');
        pageSlider.addEventListener('input', (e) => {
            updatePageNum(parseInt(e.target.value));
        });
        const prevPage = document.getElementById('tiff_prev_page');
        prevPage.addEventListener('click', (e) => {
            updatePageNum(pageNum-1);
        });
        const nextPage = document.getElementById('tiff_next_page');
        nextPage.addEventListener('click', (e) => {
            updatePageNum(pageNum+1);
        });

        // Initialize visible keypoint select
        const keypointSelect = document.getElementById('keypoints_select');
        keypointNames.forEach(element => {
            const option = document.createElement('option');
            option.textContent = element;
            option.value = element;
            keypointSelect.appendChild(option);
        })
        keypointSelect.addEventListener('change', (e) => {
            updatePageNum(pageNum);
        });

        // Initialize keypoint add button
        const keypointAdd = document.getElementById('keypoint_add');
        keypointAdd.addEventListener('click', (e) => {
            keypoints[pageNum].push({x: 0, y: 0, k: null});
            updatePageNum(pageNum);
        });

        // Initialize keypoint paste button
        const keypointPaste = document.getElementById('keypoint_paste');
        keypointPaste.addEventListener('click', (e) => {
            if ((pageNum || 0) <= 0) {
                return;
            }
            for (let index = 0; index < keypoints[pageNum].length; index++) {
                const kp = keypoints[pageNum][index];
                let minDist = -1;
                let minLabel = undefined;
                keypoints[pageNum-1].forEach((e, i) => {
                    const dist = (kp.x - e.x) * (kp.x - e.x) + (kp.y - e.y) * (kp.y - e.y)
                    if (e.k !== undefined && (minDist < 0 || minDist > dist)) {
                        minLabel = e.k;
                        minDist = dist;
                    }
                });
                keypoints[pageNum][index].k = minLabel;
            }
            updatePageNum(pageNum);
        });

        // Initialize keypoint export
        const keypointExport = document.getElementById('keypoint_export');
        keypointExport.addEventListener('click', (e) => {
            let rows = [['index', 'axis-0', 'axis-1', 'axis-2', 'keypoint']];
            let index = 0;
            keypoints.forEach((frame_kp, frame_i) => {
                frame_kp.forEach(kp => {
                    rows.push([index, frame_i, kp.y, kp.x, kp.k]);
                    index += 1;
                })
            });
            const rowsText = rows.map(r => r.join(',')).join('\n');
            const blob = new Blob([rowsText], {type: 'text/csv'});
            const link = document.createElement('a');
            document.body.appendChild(link);
            link.href = window.URL.createObjectURL(blob);
            link.download = 'keypoint.csv';
            link.click();
            document.body.removeChild(link);
        });

        updatePageNum = function(page_i) {
            // TODO: check page boundary
            pageNum = page_i;
            tiff.setDirectory(page_i);

            // Update canvas
            const imageArrayBuffer = tiff.readRGBAImage();
            const imageArray = new Uint8ClampedArray(imageArrayBuffer);
            const canvas = document.getElementById('tiff_canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = tiff.width();
            canvas.height = tiff.height();
            const imageData = ctx.createImageData(tiff.width(), tiff.height());
            imageData.data.set(imageArray);
            ctx.putImageData(imageData, 0, 0);
            // Draw keypoint circles
            const selectedKeypoint = keypointSelect.value;
            keypoints[pageNum].forEach((kp, idx) => {
                if (selectedKeypoint == '' || kp.k == selectedKeypoint) {
                    ctx.beginPath();
                    ctx.arc(kp.x * scale, kp.y * scale, keypointRadius, 0, 2*Math.PI);
                    if (idx == selectedKeypointIdx) {
                        ctx.fillStyle = selectedKeypointColor;
                    } else {
                        ctx.fillStyle = keypointColor;
                    }
                    ctx.fill();
                }
            });

            // Update frame number
            const currentPage = document.getElementById('tiff_current_page');
            currentPage.textContent = page_i + 1;

            // Update slider
            const pageSlider = document.getElementById('tiff_page_slider');
            pageSlider.value = page_i;

            // Update table
            const keypointTable = document.getElementById('keypoint_table');
            keypointTable.innerHTML = ''; // clear table
            keypoints[page_i].forEach((kp, idx) => {
                const tr = document.createElement('tr');
                const n = document.createElement('td');
                n.style.textAlign = 'right';
                n.textContent = idx+1;
                if (idx == selectedKeypointIdx) {
                    n.style.fontWeight = 'bold';
                }
                n.addEventListener('click', (event) => {
                    selectedKeypointIdx = idx;
                    updatePageNum(page_i);
                });
                tr.appendChild(n);

                const x = document.createElement('td');
                const xl = document.createElement('input');
                xl.type = 'number';
                xl.style.width = '6ch';
                xl.style.textAlign = 'right';
                xl.value = kp.x;
                xl.addEventListener('change', (event) => {
                    keypoints[page_i][idx].x = parseInt(event.target.value);
                    updatePageNum(page_i);
                });
                x.appendChild(xl);
                tr.appendChild(x);

                const y = document.createElement('td');
                const yl = document.createElement('input');
                yl.type = 'number';
                yl.style.width = '6ch';
                yl.style.textAlign = 'right';
                yl.value = kp.y;
                yl.addEventListener('change', (event) => {
                    keypoints[page_i][idx].y = parseInt(event.target.value);
                    updatePageNum(page_i);
                });
                y.appendChild(yl);
                tr.appendChild(y);

                // keypoint select
                const k = document.createElement('td');
                const kl = document.createElement('select');
                keypointNames.forEach(element => {
                    const option = document.createElement('option');
                    option.textContent = element;
                    option.value = element;
                    kl.appendChild(option);
                });
                kl.name = 'kpselect_' + page_i + '_' + idx;
                kl.value = kp.k;
                kl.addEventListener('change', (event) => {
                    keypoints[page_i][idx].k = event.target.value;
                    updatePageNum(page_i);
                });
                k.appendChild(kl);
                tr.appendChild(k);

                // delete button
                const d = document.createElement('td');
                const dl = document.createElement('button');
                dl.textContent = '削除';
                dl.addEventListener('click', (event) => {
                    keypoints[page_i].splice(idx, 1);
                    updatePageNum(page_i);
                });
                d.appendChild(dl);
                tr.appendChild(d);

                keypointTable.appendChild(tr);
            });

            // Show keypoint stats
            const keypointMsgLack = document.getElementById('keypoint_message_lack');
            const keypointMsgDupl = document.getElementById('keypoint_message_dupl');
            // count keypoint labels
            let kpLabels = {};
            keypointNames.forEach(element => {
                kpLabels[element] = [];
            })
            keypoints[page_i].forEach((element, idx) => {
                if (element.k !== undefined && element.k !== null) {
                    kpLabels[element.k].push(idx+1);
                }
            });
            let lackKps = [];
            let duplKps = [];
            keypointNames.forEach(element => {
                if (kpLabels[element].length == 0) {
                    lackKps.push(element);
                }
                if (kpLabels[element].length > 1) {
                    duplKps.push(element + '(' + kpLabels[element].join(', ') + ')');
                }
            });
            keypointMsgLack.textContent = lackKps.join(', ');
            keypointMsgDupl.textContent = duplKps.join(', ');
        }

    </script>
</body>

</html>
